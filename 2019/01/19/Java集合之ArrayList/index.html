<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Java集合之ArrayList | HQ BLOG</title><meta name="description" content="从今天开始，准备花几天时间研究下java集合中的常见数据结构。第一个看下ArrayList。(源码版本jdk1.8) ArrayList源码解析12public class ArrayList&lt;E&gt; extends AbstractList&lt;E&gt;        implements List&lt;E&gt;, RandomAccess, Cloneable, java.i"><meta name="keywords" content="java,collection"><meta name="author" content="HuangQiang"><meta name="copyright" content="HuangQiang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2019/01/19/Java%E9%9B%86%E5%90%88%E4%B9%8BArrayList/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Java集合之ArrayList"><meta property="og:url" content="http://yoursite.com/2019/01/19/Java%E9%9B%86%E5%90%88%E4%B9%8BArrayList/"><meta property="og:site_name" content="HQ BLOG"><meta property="og:description" content="从今天开始，准备花几天时间研究下java集合中的常见数据结构。第一个看下ArrayList。(源码版本jdk1.8) ArrayList源码解析12public class ArrayList&lt;E&gt; extends AbstractList&lt;E&gt;        implements List&lt;E&gt;, RandomAccess, Cloneable, java.i"><meta property="og:image" content="http://yoursite.com/img/avatar.jpg"><meta property="article:published_time" content="2019-01-19T12:01:57.000Z"><meta property="article:modified_time" content="2020-09-05T13:56:20.205Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.1.1',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime: '',
  date_suffix: {"one_hour":"刚刚","hours":"小时前","day":"天前"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
    },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-09-05 21:56:20'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
  }
}

var autoChangeMode = 'false'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><meta name="generator" content="Hexo 5.1.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">36</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">13</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/Gallery"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ArrayList%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">ArrayList源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.</span> <span class="toc-text">构造方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#add"><span class="toc-number">1.2.</span> <span class="toc-text">add</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#remove"><span class="toc-number">1.3.</span> <span class="toc-text">remove</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#fail-fast"><span class="toc-number">1.3.1.</span> <span class="toc-text">fail-fast</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SubList"><span class="toc-number">1.4.</span> <span class="toc-text">SubList</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96public%E6%96%B9%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">其他public方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.</span> <span class="toc-text">一些问题</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/09/06/1wgrbldpGcPK82A.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">HQ BLOG</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/Gallery"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Java集合之ArrayList</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-01-19T12:01:57.000Z" title="发表于 2019-01-19 20:01:57">2019-01-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-09-05T13:56:20.205Z" title="更新于 2020-09-05 21:56:20">2020-09-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>11分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p>从今天开始，准备花几天时间研究下java集合中的常见数据结构。第一个看下ArrayList。(源码版本jdk1.8)</p>
<h2 id="ArrayList源码解析"><a href="#ArrayList源码解析" class="headerlink" title="ArrayList源码解析"></a>ArrayList源码解析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure>
<p>首先ArrayList继承了AbstractList抽象类，AbstractList继承了AbstractCollection抽象类和List接口，AbstractList最小化的实现了对随机访问支持的list所需的工作。此外还继承了List，RandomAccess，Cloneable，Serializable这四个接口。通过这个四个接口可以对ArrayList的功能有个初步了解。<br>List是一个有序集合，使用者可以通过数字索引来访问List中的元素，并且可以存储重复元素和空元素。并且List通过Collection接口继承了Iterable接口，继承了Iterable接口的类或接口允许作为for-each语法操作的对象，Iterable接口还定义iterator方法返回一个Iterator对象的迭代器来迭代。<br>RandomAccess接口标记一个List支持快速随机访问，至于如何实现快速随机访问，在更具体的源码解析的时会说明如何实现快速随机访问的功能。<br>Cloneable接口标记这个实现类可以通过Object的clone方法来复制对象实例。<br>Serializable接口标记这个类可以序列化或者反序列化。</p>
<h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"><span class="keyword">transient</span> Object[] elementData;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal Capacity: &quot;</span>+</span><br><span class="line">                                               initialCapacity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">        elementData = c.toArray();</span><br><span class="line">        <span class="keyword">if</span> ((size = elementData.length) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span></span><br><span class="line">            <span class="keyword">if</span> (elementData.getClass() != Object[].class)</span><br><span class="line">                elementData = Arrays.copyOf(elementData, size, Object[].class);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// replace with empty array.</span></span><br><span class="line">            <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如上，ArrayList提供了三种构造方法来创建ArrayList实例，并且提供了两个静态私有Object的空数组EMPTY_ELEMENTDATA，DEFAULTCAPACITY_EMPTY_ELEMENTDATA。前者用于指定了初始数组大小的构造方法ArrayList(int initialCapacity)中初始大小为0或通过一个已经存在的Collection实例来创建ArrayList时Collection为空时，后者用于无参构造方法ArrayList()创建一个初始大小为0的ArrayList，而且区分开始是为了在第一个元素添加时候区分数组膨胀多少。这两者也有一个共同作用就是懒初始化在java1.7在java集合中广泛使用。在初始化ArrayList时先将一个初始化好的空数组赋值，只有在第一次添加操作之后才真正初始化。这样可以节省内存空间，不用null是为了避免null值判断成空值。<br>通过这段代码我们可以知道ArrayList中的数据其实存在一个Object数组中，所以ArrayList的底层实现就是java数组。</p>
<h3 id="add"><a href="#add" class="headerlink" title="add"></a>add</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    ensureCapacityInternal(size + 1);  &#x2F;&#x2F; Increments modCount!!</span><br><span class="line">    elementData[size++] &#x3D; e;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void add(int index, E element) &#123;</span><br><span class="line">    rangeCheckForAdd(index);</span><br><span class="line">    ensureCapacityInternal(size + 1);  &#x2F;&#x2F; Increments modCount!!</span><br><span class="line">    System.arraycopy(elementData, index, elementData, index + 1,</span><br><span class="line">                     size - index);</span><br><span class="line">    elementData[index] &#x3D; element;</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ArrayList的add方法我觉得是ArrayList中最需要理解的方法，从add方法我们可以深入理解ArrayList的设计思想。<br>ArrayList提供了两种add方法。<br>第一种add(E e)新增一个数据到ArrayList最后正确运行之后会返回true，首先会调用这个方法：ensureCapacityInternal(size + 1); 这个方法的具体运行过程是先将当前数组大小和size+1也就新增元素之后数组最小容量比较来得出数组扩容后的大小，注意如果此时数组是DEFAULTCAPACITY_EMPTY_ELEMENTDATA的话返回的值是DEFAULT_CAPACITY这个默认值。<br>具体对数组进行扩容的方法是grow(int minCapacity)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void grow(int minCapacity) &#123;</span><br><span class="line">    &#x2F;&#x2F; overflow-conscious code</span><br><span class="line">    int oldCapacity &#x3D; elementData.length;</span><br><span class="line">    int newCapacity &#x3D; oldCapacity + (oldCapacity &gt;&gt; 1);</span><br><span class="line">    if (newCapacity - minCapacity &lt; 0)</span><br><span class="line">        newCapacity &#x3D; minCapacity;</span><br><span class="line">    if (newCapacity - MAX_ARRAY_SIZE &gt; 0)</span><br><span class="line">        newCapacity &#x3D; hugeCapacity(minCapacity);</span><br><span class="line">    &#x2F;&#x2F; minCapacity is usually close to size, so this is a win:</span><br><span class="line">    elementData &#x3D; Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br><span class="line">private static int hugeCapacity(int minCapacity) &#123;</span><br><span class="line">    if (minCapacity &lt; 0) &#x2F;&#x2F; overflow</span><br><span class="line">        throw new OutOfMemoryError();</span><br><span class="line">    return (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">        Integer.MAX_VALUE :</span><br><span class="line">        MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外给出java1.6中使用扩容方法来比较1.7之后算法的优化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;jdk1.6</span><br><span class="line">public void ensureCapacity(int minCapacity) &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    int oldCapacity &#x3D; elementData.length;</span><br><span class="line">    if (minCapacity &gt; oldCapacity) &#123;</span><br><span class="line">        Object oldData[] &#x3D; elementData;  </span><br><span class="line">        int newCapacity &#x3D; (oldCapacity * 3)&#x2F;2 + 1;  </span><br><span class="line">        if (newCapacity &lt; minCapacity)  </span><br><span class="line">            newCapacity &#x3D; minCapacity;  </span><br><span class="line">        &#x2F;&#x2F; minCapacity is usually close to size, so this is a win:  </span><br><span class="line">        elementData &#x3D; Arrays.copyOf(elementData, newCapacity);  </span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>可以看的出来newCapacity在1.6中等于(oldCapacity * 3)/2 + 1，1.7以后等于oldCapacity + (oldCapacity &gt;&gt; 1)，粗略的看二者大致都等于1.5倍的oldCapacity（加1的差别忽略不计的话），但是1.6的算法在oldCapacity很大的时候会造成int溢出最终导致可以扩容1.5倍的容量由于溢出成负值最后变成按需扩容，另外1.6的内部和外部扩容都是用ensureCapacity(int minCapacity)并且没有对minCapacity作负值判断，1.7以后的代码在外部调用扩容方法时做了处理规避这个问题，另外hugeCapacity中在minCapacity&lt;0时抛出OOM异常，并且规定了数组最大不会超过int的最大值，并且minCapacity不超过MAX_ARRAY_SIZE最大值为MAX_ARRAY_SIZE(int的最大值-8)，<br>第二种方法add(int index, E element)无返回值，通过源码我们可知这个是将element添加到数组index索引这个位置的方法并将当前索引及后面的值后移，具体是先扩容数组然后将位于index索引这个数据以及后面的数据后移一位，然后将element赋值。</p>
<h3 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public E remove(int index) &#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    modCount++;</span><br><span class="line">    E oldValue &#x3D; elementData(index);</span><br><span class="line">    int numMoved &#x3D; size - index - 1;</span><br><span class="line">    if (numMoved &gt; 0)</span><br><span class="line">        System.arraycopy(elementData, index+1, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--size] &#x3D; null; &#x2F;&#x2F; clear to let GC do its work</span><br><span class="line">    return oldValue;</span><br><span class="line">&#125;</span><br><span class="line">public boolean remove(Object o) &#123;</span><br><span class="line">    if (o &#x3D;&#x3D; null) &#123;</span><br><span class="line">        for (int index &#x3D; 0; index &lt; size; index++)</span><br><span class="line">            if (elementData[index] &#x3D;&#x3D; null) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        for (int index &#x3D; 0; index &lt; size; index++)</span><br><span class="line">            if (o.equals(elementData[index])) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">private void fastRemove(int index) &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    int numMoved &#x3D; size - index - 1;</span><br><span class="line">    if (numMoved &gt; 0)</span><br><span class="line">        System.arraycopy(elementData, index+1, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--size] &#x3D; null; &#x2F;&#x2F; clear to let GC do its work</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由源码可知remove主要其作用的代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int numMoved &#x3D; size - index - 1;</span><br><span class="line">if (numMoved &gt; 0)</span><br><span class="line">   System.arraycopy(elementData, index+1, elementData, index,</span><br><span class="line">      numMoved);</span><br></pre></td></tr></table></figure>
<p>这段代码的作用是将index也就是要删除的数据的索引后面的值全部前移一位，最后将末尾的值置null。注意remove(Object o)不会删除list中的所有o元素只会删除匹配的第一个。</p>
<p>###迭代器<br>迭代器是用来遍历容器内元素的工具。ArrayList提供了三种迭代器，分别是Itr和ListItr以及ArrayListSpliterator，前二者都是ArrayList的私有内部类，ArrayList提供了iterator和listIterator两个方法来分别返回这两个迭代器使用，第三个是静态final内部类通过spliterator()来获取。</p>
<ul>
<li><p>Itr<br>Itr继承了Iterator接口，提供hasNext()来确定迭代器游标是否到达ArrayList末尾(确定遍历是否完成)，next()返回数组当前游标位置的值并将游标值加1，remove()删除游标前面一位的值后面的值前移（这个方法必须在next()之后调用，因为删除的索引值lastRet在next()之前为-1之后才会等于游标值-1，并且每次remove后都会重置lastRet值）</p>
</li>
<li><p>ListItr<br>ListItr继承了Itr这个内部类和ListIterator接口，ListItr相对Itr更灵活功能更强大，ListItr的构造方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ListItr(<span class="keyword">int</span> index) &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    cursor = index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ListItr在创建的时候就可以指定游标的位置，提供hasPrevious()来判断迭代器是否达到List末尾，nextIndex()返回游标-1位置的值，previousIndex()对游标减1，previous()获取游标位置的值并将游标减1，set(E e)改变游标位置的值，add(E e)在游标位置后面新增元素e。<br>宗上可知Itr是顺序遍历且只能取值或删除元素，ListItr是倒序遍历而且可以增改查。</p>
</li>
<li><p>ArrayListSpliterator<br>ArrayListSpliterator继承了Spliterator接口，Spliterator是一个可分割迭代器从java8之后java集合新增的功能。关于这个迭代器后面会单独用一文来深究，这里只大概说下功能，这个迭代器在多线程并行遍历的情况是安全的。</p>
</li>
</ul>
<h4 id="fail-fast"><a href="#fail-fast" class="headerlink" title="fail-fast"></a>fail-fast</h4><p>fail-fast 机制是java集合(Collection)中的一种错误机制。 当多个线程对同一个集合的内容进行操作时，就可能会产生fail-fast事件。<br>ArrayList中fail-fast的实现机制是通过继承自AbstractList的modCount来判断，在每次改变ArrayList之后modCount都会加1，在迭代器创建的时候通过一个final变量存储这个值每次迭代操作都会对这个值作比较，如果发现不一致就会抛出ConcurrentModificationException。<br>但是fail-fast并不能保证多线程情况一定安全，因为本身modCount的操作就不是原子性也没有作任何线程安全的处理。</p>
<h3 id="SubList"><a href="#SubList" class="headerlink" title="SubList"></a>SubList</h3><p>SubList是ArrayList的私有内部类。ArrayList的subList(int fromIndex, int toIndex)返回一个SubList对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    public List&lt;E&gt; subList(int fromIndex, int toIndex) &#123;</span><br><span class="line">        subListRangeCheck(fromIndex, toIndex, size);</span><br><span class="line">        return new SubList(this, 0, fromIndex, toIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    private class SubList extends AbstractList&lt;E&gt; implements RandomAccess &#123;</span><br><span class="line">        private final AbstractList&lt;E&gt; parent;</span><br><span class="line">        private final int parentOffset;</span><br><span class="line">        private final int offset;</span><br><span class="line">        int size;</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">        SubList(AbstractList&lt;E&gt; parent,</span><br><span class="line">                int offset, int fromIndex, int toIndex) &#123;</span><br><span class="line">            this.parent &#x3D; parent;</span><br><span class="line">            this.parentOffset &#x3D; fromIndex;</span><br><span class="line">            this.offset &#x3D; offset + fromIndex;</span><br><span class="line">            this.size &#x3D; toIndex - fromIndex;</span><br><span class="line">            this.modCount &#x3D; ArrayList.this.modCount;</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>所有其实SubList并没有真的分割原有ArrayList只是在其之上做增删该查。</p>
<h3 id="其他public方法"><a href="#其他public方法" class="headerlink" title="其他public方法"></a>其他public方法</h3><ul>
<li>trimToSize():缩小ArrayList大小为实际所需大小,建议在确定不新增元素后使用，节省空间。同样基于Arrays.copyOf来执行。</li>
<li>ensureCapacity(int minCapacity):提供给外部调用者来对数组扩容。</li>
<li>size():获取数组元素个数。</li>
<li>isEmpty():或数组元素个数为0返回true否则false。</li>
<li>contains(Object o):若数组中有这个元素o返回true否则false，本质是判断indexOf(o)是否大于等于0。</li>
<li>indexOf(Object o):若数组有这个元素o返回匹配它的第一个索引，否则返回-1，非空元素通过equals比较。</li>
<li>lastIndexOf(Object o):倒序的indexOf返回最后一个匹配的索引，未匹配返回-1。</li>
<li>clone():根据当前实例复制一个大小为size，元素相同的ArrayList，并且modCount(ArrayList改变次数，继承自AbstractList)置为0。</li>
<li>toArray():返回一个大小为size，元素相同的java数组。</li>
<li>toArray(T[] a):将ArrayList中的数据复制到a中，如果a.length&lt;size会自动给a扩容。</li>
<li>get(int index):根据索引获取数组中对应位置的值。</li>
<li>set(int index, E element):为对应索引位置赋新值，返回旧的值。</li>
<li>clear():遍历ArrayList中索引小于size的元素置null，siez置0。</li>
<li>addAll(Collection&lt;? extends E&gt; c):添加一个Collection实例到ArrayList末尾，返回值c.length！=0。</li>
<li>addAll(int index, Collection&lt;? extends E&gt; c):添加一个Collection实例到ArrayList制定索引处，返回值c.length！=0。</li>
<li>removeAll(Collection&lt;?&gt; c):从ArrayList删除所有集合c中存在的元素，返回操作是否成功。</li>
<li>retainAll(Collection&lt;?&gt; c):从ArrayList删除所有集合c中不存在的元素，返回操作是否成功。</li>
<li>forEach(Consumer&lt;? super E&gt; action):数组遍历并通过函数式编程获取值。</li>
<li>clone():复制一个实例，深克隆，重写了clone方法通过System.arraycopy来copy。</li>
</ul>
<h3 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h3><p>1.扩容1.5倍的原因:<br>   至于扩容时扩容1.5倍的原因是避免频繁扩容数组，数组的申请需要连续的空间操作耗时多频繁操作降低代码执行效率。<br>2.ArrayList的效率:<br>   另外源码中可以看出ArrayList在新增和删除时会调用System.arraycopy(Arrays.copyOf终归也是调用这个方法)这个操作效率很低所以ArrayList不适合频繁增删的应用场景。<br>3.ArrayList多线程安全问题:<br>   ArrayList的增删改查不是线程安全的。</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">HuangQiang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2019/01/19/Java%E9%9B%86%E5%90%88%E4%B9%8BArrayList/">http://yoursite.com/2019/01/19/Java%E9%9B%86%E5%90%88%E4%B9%8BArrayList/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">HQ BLOG</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/collection/">collection</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/01/22/RandomAccess/"><img class="prev-cover" src="/null" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">RandomAccess</div></div></a></div><div class="next-post pull-right"><a href="/2018/12/12/jdk%E5%92%8Cjre%E6%8E%A2%E7%A9%B6/"><img class="next-cover" src="/null" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">jdk和jre探究</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/02/02/Java集合之EnumMap/" title="Java集合之EnumMap"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-02-02</div><div class="title">Java集合之EnumMap</div></div></a></div><div><a href="/2019/02/02/Java集合之HashSet/" title="Java集合之HashSet"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-02-02</div><div class="title">Java集合之HashSet</div></div></a></div><div><a href="/2019/01/24/Java集合之LinkedList/" title="Java集合之LinkedList"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-01-24</div><div class="title">Java集合之LinkedList</div></div></a></div><div><a href="/2019/01/24/Java集合之Vector/" title="Java集合之Vector"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-01-24</div><div class="title">Java集合之Vector</div></div></a></div><div><a href="/2019/01/25/Java集合之HashMap/" title="Java集合之HashMap"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-01-25</div><div class="title">Java集合之HashMap</div></div></a></div><div><a href="/2017/11/17/AutoWired异常/" title="AutoWired异常"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-11-17</div><div class="title">AutoWired异常</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2021 By HuangQiang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, this is hq's blog</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>