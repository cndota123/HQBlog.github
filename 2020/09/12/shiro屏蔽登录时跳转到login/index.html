<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>shiro屏蔽登录时跳转到login | HQ BLOG</title><meta name="description" content="问题这个问题在一次前端访问接口时无法正确返回结果，后台无报错，而且这个接口在Insomnia是测试通过的，后来对前端的代理服务器打印请求响应发现服务器返回了302，接触过shiro的应该知道，shiro默认的验证拦截器在未登录时访问需要验证的接口会跳转到login页面，但是我其实在自定义的filter中定义了未登录时的响应逻辑 查错和解决方案首先项目代码结构基本和shiro-spring自定义fi"><meta name="keywords" content="java,spring,security,shiro"><meta name="author" content="HuangQiang"><meta name="copyright" content="HuangQiang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2020/09/12/shiro%E5%B1%8F%E8%94%BD%E7%99%BB%E5%BD%95%E6%97%B6%E8%B7%B3%E8%BD%AC%E5%88%B0login/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="shiro屏蔽登录时跳转到login"><meta property="og:url" content="http://yoursite.com/2020/09/12/shiro%E5%B1%8F%E8%94%BD%E7%99%BB%E5%BD%95%E6%97%B6%E8%B7%B3%E8%BD%AC%E5%88%B0login/"><meta property="og:site_name" content="HQ BLOG"><meta property="og:description" content="问题这个问题在一次前端访问接口时无法正确返回结果，后台无报错，而且这个接口在Insomnia是测试通过的，后来对前端的代理服务器打印请求响应发现服务器返回了302，接触过shiro的应该知道，shiro默认的验证拦截器在未登录时访问需要验证的接口会跳转到login页面，但是我其实在自定义的filter中定义了未登录时的响应逻辑 查错和解决方案首先项目代码结构基本和shiro-spring自定义fi"><meta property="og:image" content="https://i.loli.net/2020/09/06/1wgrbldpGcPK82A.jpg"><meta property="article:published_time" content="2020-09-12T02:05:50.000Z"><meta property="article:modified_time" content="2020-09-28T14:55:18.120Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.1.1',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime: '',
  date_suffix: {"one_hour":"刚刚","hours":"小时前","day":"天前"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
    },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-09-28 22:55:18'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
  }
}

var autoChangeMode = 'false'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><meta name="generator" content="Hexo 5.1.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">36</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">13</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/Gallery"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E9%94%99%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.</span> <span class="toc-text">查错和解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#shiro%E6%8B%A6%E6%88%AA%E5%99%A8%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.1.</span> <span class="toc-text">shiro拦截器的初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shiro-spring%E7%9A%84%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">3.2.</span> <span class="toc-text">shiro-spring的拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8%E5%A6%82%E4%BD%95%E4%BD%9C%E7%94%A8"><span class="toc-number">3.3.</span> <span class="toc-text">拦截器如何作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shiro%E7%9A%84session%E6%9C%BA%E5%88%B6"><span class="toc-number">3.4.</span> <span class="toc-text">shiro的session机制</span></a></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/09/06/1wgrbldpGcPK82A.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">HQ BLOG</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/Gallery"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">shiro屏蔽登录时跳转到login</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-09-12T02:05:50.000Z" title="发表于 2020-09-12 10:05:50">2020-09-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-09-28T14:55:18.120Z" title="更新于 2020-09-28 22:55:18">2020-09-28</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>19分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>这个问题在一次前端访问接口时无法正确返回结果，后台无报错，而且这个接口在Insomnia是测试通过的，后来对前端的代理服务器打印请求响应发现服务器返回了302，接触过shiro的应该知道，shiro默认的验证拦截器在未登录时访问需要验证的接口会跳转到login页面，但是我其实在自定义的filter中定义了未登录时的响应逻辑</p>
<h3 id="查错和解决方案"><a href="#查错和解决方案" class="headerlink" title="查错和解决方案"></a>查错和解决方案</h3><p>首先项目代码结构基本和<a href="/2020/09/05/shiro%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F/" title="shiro-spring自定义filter">shiro-spring自定义filter</a>中的一致，shiroConfig中的ShiroFilterFactoryBean类似下面:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public ShiroFilterFactoryBean shiroFilterFactoryBean(SecurityManager securityManager) &#123;</span><br><span class="line">    ShiroFilterFactoryBean shiroFilterFactoryBean &#x3D; new ShiroFilterFactoryBean();</span><br><span class="line">    shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">    Map&lt;String, Filter&gt; filterMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">    &#x2F;&#x2F; 注意这里的JwtFilter不能使用spring的bean来注入，否则会使shiro默认的Filter失效</span><br><span class="line">    filterMap.put(&quot;jwt&quot;, new JWTFilter());</span><br><span class="line">    shiroFilterFactoryBean.setFilters(filterMap);</span><br><span class="line">    &#x2F;&#x2F; 注意filterChainDefinitionMap必须是有序的,不然不一定按你预想的次序工作</span><br><span class="line">    Map&lt;String, String&gt; filterChainDefinitionMap &#x3D; new LinkedHashMap&lt;&gt;();</span><br><span class="line">    filterChainDefinitionMap.put(&quot;&#x2F;login&quot;, &quot;anon&quot;);</span><br><span class="line">    filterChainDefinitionMap.put(&quot;&#x2F;test&#x2F;role&quot;, &quot;roles[admin]&quot;);</span><br><span class="line">    filterChainDefinitionMap.put(&quot;&#x2F;test&#x2F;perms&quot;, &quot;perms[admin]&quot;);</span><br><span class="line">    filterChainDefinitionMap.put(&quot;&#x2F;**&quot;, &quot;jwt&quot;);</span><br><span class="line">    shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">    return shiroFilterFactoryBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于http响应302，原因是重定向到login.jsp这个默认的登录网页了，我猜测是shiro原生的authc filter生效了，恰好这个接口是要求role权限的，于是我猜测<code>filterChainDefinitionMap.put(&quot;/test/role&quot;, &quot;roles[admin]&quot;)</code>这样的写法还是会调用authc这个默认的filter，最开始我尝试将jwt这个filter改名成authc来替换掉原生的authc，结果没用，于是将代码改成这样<code>filterChainDefinitionMap.put(&quot;/test/role&quot;, &quot;jwt,roles[admin]&quot;)</code>,生效了，前端可以正确进行role权限验证并且未登录的情况返回的也是jwt filter定义的响应体</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>上述是解决了问题但是问题产生的原因还是处于猜想阶段，这里从源码实现的角度来思考下述三个问题，</p>
<ol>
<li><code>filterChainDefinitionMap.put(&quot;/test/role&quot;, &quot;roles[admin]&quot;)</code>为什么还是会进入authc这个默认的filter</li>
<li>自定义的filter在filterMap中key命名为默认的filter的名字为什么无法替换</li>
<li>Insomnia可以通过，但是前端通过代理无法成功</li>
</ol>
<h4 id="shiro拦截器的初始化"><a href="#shiro拦截器的初始化" class="headerlink" title="shiro拦截器的初始化"></a>shiro拦截器的初始化</h4><p>为了解释这些问题，我们需要对shiro拦截器的实现有更深入的了解</p>
<p>首先shiro-web的功能入口是ShiroFilter这个类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class ShiroFilter extends AbstractShiroFilter &#123;</span><br><span class="line">    public ShiroFilter() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void init() throws Exception &#123;</span><br><span class="line">        WebEnvironment env &#x3D; WebUtils.getRequiredWebEnvironment(this.getServletContext());</span><br><span class="line">        this.setSecurityManager(env.getWebSecurityManager());</span><br><span class="line">        FilterChainResolver resolver &#x3D; env.getFilterChainResolver();</span><br><span class="line">        if (resolver !&#x3D; null) &#123;</span><br><span class="line">            this.setFilterChainResolver(resolver);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>WebEnvironment env = WebUtils.getRequiredWebEnvironment(this.getServletContext())</code>这一行代码主要就是获取WebEnvironment，这就涉及到WebEnvironment的初始化，WebEnvironment的初始化是由EnvironmentLoader这个类来实现的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class EnvironmentLoaderListener extends EnvironmentLoader implements ServletContextListener &#123;</span><br><span class="line">    public EnvironmentLoaderListener() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void contextInitialized(ServletContextEvent sce) &#123;</span><br><span class="line">        this.initEnvironment(sce.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void contextDestroyed(ServletContextEvent sce) &#123;</span><br><span class="line">        this.destroyEnvironment(sce.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EnvironmentLoaderListener继承了EnvironmentLoader和ServletContextListener，并且contextInitialized方法中调用initEnvironment方法来初始化WebEnvironment</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">    public static final String ENVIRONMENT_ATTRIBUTE_KEY &#x3D; EnvironmentLoader.class.getName() + &quot;.ENVIRONMENT_ATTRIBUTE_KEY&quot;;</span><br><span class="line">...</span><br><span class="line">    public WebEnvironment initEnvironment(ServletContext servletContext) throws IllegalStateException &#123;</span><br><span class="line">        if (servletContext.getAttribute(ENVIRONMENT_ATTRIBUTE_KEY) !&#x3D; null) &#123;</span><br><span class="line">            String msg &#x3D; &quot;There is already a Shiro environment associated with the current ServletContext.  Check if you have multiple EnvironmentLoader* definitions in your web.xml!&quot;;</span><br><span class="line">            throw new IllegalStateException(msg);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            servletContext.log(&quot;Initializing Shiro environment&quot;);</span><br><span class="line">            log.info(&quot;Starting Shiro environment initialization.&quot;);</span><br><span class="line">            long startTime &#x3D; System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                WebEnvironment environment &#x3D; this.createEnvironment(servletContext);</span><br><span class="line">                servletContext.setAttribute(ENVIRONMENT_ATTRIBUTE_KEY, environment);</span><br><span class="line">                log.debug(&quot;Published WebEnvironment as ServletContext attribute with name [&#123;&#125;]&quot;, ENVIRONMENT_ATTRIBUTE_KEY);</span><br><span class="line">                if (log.isInfoEnabled()) &#123;</span><br><span class="line">                    long elapsed &#x3D; System.currentTimeMillis() - startTime;</span><br><span class="line">                    log.info(&quot;Shiro environment initialized in &#123;&#125; ms.&quot;, elapsed);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                return environment;</span><br><span class="line">            &#125; catch (RuntimeException var7) &#123;</span><br><span class="line">                log.error(&quot;Shiro environment initialization failed&quot;, var7);</span><br><span class="line">                servletContext.setAttribute(ENVIRONMENT_ATTRIBUTE_KEY, var7);</span><br><span class="line">                throw var7;</span><br><span class="line">            &#125; catch (Error var8) &#123;</span><br><span class="line">                log.error(&quot;Shiro environment initialization failed&quot;, var8);</span><br><span class="line">                servletContext.setAttribute(ENVIRONMENT_ATTRIBUTE_KEY, var8);</span><br><span class="line">                throw var8;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected WebEnvironment createEnvironment(ServletContext sc) &#123;</span><br><span class="line">        WebEnvironment webEnvironment &#x3D; this.determineWebEnvironment(sc);</span><br><span class="line">        if (!MutableWebEnvironment.class.isInstance(webEnvironment)) &#123;</span><br><span class="line">            throw new ConfigurationException(&quot;Custom WebEnvironment class [&quot; + webEnvironment.getClass().getName() + &quot;] is not of required type [&quot; + MutableWebEnvironment.class.getName() + &quot;]&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String configLocations &#x3D; sc.getInitParameter(&quot;shiroConfigLocations&quot;);</span><br><span class="line">            boolean configSpecified &#x3D; StringUtils.hasText(configLocations);</span><br><span class="line">            if (configSpecified &amp;&amp; !ResourceConfigurable.class.isInstance(webEnvironment)) &#123;</span><br><span class="line">                String msg &#x3D; &quot;WebEnvironment class [&quot; + webEnvironment.getClass().getName() + &quot;] does not implement the &quot; + ResourceConfigurable.class.getName() + &quot;interface.  This is required to accept any configured &quot; + &quot;shiroConfigLocations&quot; + &quot;value(s).&quot;;</span><br><span class="line">                throw new ConfigurationException(msg);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                MutableWebEnvironment environment &#x3D; (MutableWebEnvironment)webEnvironment;</span><br><span class="line">                environment.setServletContext(sc);</span><br><span class="line">                if (configSpecified &amp;&amp; environment instanceof ResourceConfigurable) &#123;</span><br><span class="line">                    ((ResourceConfigurable)environment).setConfigLocations(configLocations);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                this.customizeEnvironment(environment);</span><br><span class="line">                LifecycleUtils.init(environment);</span><br><span class="line">                return environment;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected WebEnvironment determineWebEnvironment(ServletContext servletContext) &#123;</span><br><span class="line">        &#x2F;&#x2F; 读取web配置中shiroEnvironmentClass</span><br><span class="line">        Class&lt;? extends WebEnvironment&gt; webEnvironmentClass &#x3D; this.webEnvironmentClassFromServletContext(servletContext);</span><br><span class="line">        WebEnvironment webEnvironment &#x3D; null;</span><br><span class="line">        if (webEnvironmentClass &#x3D;&#x3D; null) &#123;</span><br><span class="line">            webEnvironment &#x3D; this.webEnvironmentFromServiceLoader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; return IniWebEnvironment.class;</span><br><span class="line">        if (webEnvironmentClass &#x3D;&#x3D; null &amp;&amp; webEnvironment &#x3D;&#x3D; null) &#123;</span><br><span class="line">            webEnvironmentClass &#x3D; this.getDefaultWebEnvironmentClass();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (webEnvironmentClass !&#x3D; null) &#123;</span><br><span class="line">            webEnvironment &#x3D; (WebEnvironment)ClassUtils.newInstance(webEnvironmentClass);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return webEnvironment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>initEnvironment方法中关于初始化WebEnvironment是createEnvironment，determineWebEnvironment负责创建WebEnvironment的实例，默认的实例是IniWebEnvironment，其中关于拦截器的初始化在<code>LifecycleUtils.init(environment)</code>中执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public static void init(Object o) throws ShiroException &#123;</span><br><span class="line">    if (o instanceof Initializable) &#123;</span><br><span class="line">        init((Initializable)o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void init(Initializable initializable) throws ShiroException &#123;</span><br><span class="line">    initializable.init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LifecycleUtils的init方法如上，其实就是调用入参的init方法，同样可以看到environment应该继承了Initializable，默认的WebEnvironment实现类IniWebEnvironment就继承Initializable接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">public void init() &#123;</span><br><span class="line">    this.setIni(this.parseConfig());</span><br><span class="line">    this.configure();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected void configure() &#123;</span><br><span class="line">    this.objects.clear();</span><br><span class="line">    WebSecurityManager securityManager &#x3D; this.createWebSecurityManager();</span><br><span class="line">    this.setWebSecurityManager(securityManager);</span><br><span class="line">    FilterChainResolver resolver &#x3D; this.createFilterChainResolver();</span><br><span class="line">    if (resolver !&#x3D; null) &#123;</span><br><span class="line">        this.setFilterChainResolver(resolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected Ini parseConfig() &#123;</span><br><span class="line">    Ini ini &#x3D; this.getIni();</span><br><span class="line">    &#x2F;&#x2F; 获取配置文件中的configLocations </span><br><span class="line">    String[] configLocations &#x3D; this.getConfigLocations();</span><br><span class="line">    if (log.isWarnEnabled() &amp;&amp; !CollectionUtils.isEmpty(ini) &amp;&amp; configLocations !&#x3D; null &amp;&amp; configLocations.length &gt; 0) &#123;</span><br><span class="line">        log.warn(&quot;Explicit INI instance has been provided, but configuration locations have also been specified.  The &#123;&#125; implementation does not currently support multiple Ini config, but this may be supported in the future. Only the INI instance will be used for configuration.&quot;, IniWebEnvironment.class.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">        log.debug(&quot;Checking any specified config locations.&quot;);</span><br><span class="line">        ini &#x3D; this.getSpecifiedIni(configLocations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">        log.debug(&quot;No INI instance or config locations specified.  Trying default config locations.&quot;);</span><br><span class="line">        ini &#x3D; this.getDefaultIni();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ini &#x3D; this.mergeIni(this.getFrameworkIni(), ini);</span><br><span class="line">    if (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">        String msg &#x3D; &quot;Shiro INI configuration was either not found or discovered to be empty&#x2F;unconfigured.&quot;;</span><br><span class="line">        throw new ConfigurationException(msg);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return ini;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected final Map&lt;String, Object&gt; objects;</span><br><span class="line"></span><br><span class="line">protected FilterChainResolver createFilterChainResolver() &#123;</span><br><span class="line">    FilterChainResolver resolver &#x3D; null;</span><br><span class="line">    Ini ini &#x3D; this.getIni();</span><br><span class="line">    if (!CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">        Section urls &#x3D; ini.getSection(&quot;urls&quot;);</span><br><span class="line">        Section filters &#x3D; ini.getSection(&quot;filters&quot;);</span><br><span class="line">        if (!CollectionUtils.isEmpty(urls) || !CollectionUtils.isEmpty(filters)) &#123;</span><br><span class="line">            Factory&lt;FilterChainResolver&gt; factory &#x3D; (Factory)this.objects.get(&quot;filterChainResolver&quot;);</span><br><span class="line">            if (factory instanceof IniFactorySupport) &#123;</span><br><span class="line">                IniFactorySupport iniFactory &#x3D; (IniFactorySupport)factory;</span><br><span class="line">                iniFactory.setIni(ini);</span><br><span class="line">                iniFactory.setDefaults(this.objects);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            resolver &#x3D; (FilterChainResolver)factory.getInstance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return resolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>parseConfig方法主要是初始化ini，也就是关于WebSecurityManager和FilterChainResolver的配置，FilterChainResolver中就有我们配置中自定义的filter和默认filter<br>createFilterChainResolver方法创建了FilterChainResolver，其中从ini读取了两个Section，一个urls一个filters，Section继承了Map，这个两个配置文件就是shiro关于路径的拦截器设置<br><code>resolver = (FilterChainResolver)factory.getInstance()</code>是FilterChainResolver的创建代码，具体作用的代码是IniFilterChainResolverFactory类中createDefaultInstance方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected FilterChainResolver createDefaultInstance() &#123;</span><br><span class="line">    FilterConfig filterConfig &#x3D; this.getFilterConfig();</span><br><span class="line">    return filterConfig !&#x3D; null ? new PathMatchingFilterChainResolver(filterConfig) : new PathMatchingFilterChainResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中涉及多个类之间继承关系因此暂且跳过(可以通过编译器进入具体方法来看，shiro的类继承不是很复杂很容易找到具体的实现类是哪一个)，不过可以看到FilterChainResolver就是PathMatchingFilterChainResolver，它是一个路径匹配的filter处理器</p>
<p>自此我们应该对shiro-web的初始化基本了解了，下面可以对shiro-spring进行分析</p>
<h4 id="shiro-spring的拦截器"><a href="#shiro-spring的拦截器" class="headerlink" title="shiro-spring的拦截器"></a>shiro-spring的拦截器</h4><p>首先可以想一想shiro-spring中配置与拦截器相关的是ShiroFilterFactoryBean的初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">public class ShiroFilterFactoryBean implements FactoryBean, BeanPostProcessor &#123;</span><br><span class="line"></span><br><span class="line">    public Object getObject() throws Exception &#123;</span><br><span class="line">        if (this.instance &#x3D;&#x3D; null) &#123;</span><br><span class="line">            this.instance &#x3D; this.createInstance();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return this.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected AbstractShiroFilter createInstance() throws Exception &#123;</span><br><span class="line">        log.debug(&quot;Creating Shiro Filter instance.&quot;);</span><br><span class="line">        SecurityManager securityManager &#x3D; this.getSecurityManager();</span><br><span class="line">        String msg;</span><br><span class="line">        if (securityManager &#x3D;&#x3D; null) &#123;</span><br><span class="line">            msg &#x3D; &quot;SecurityManager property must be set.&quot;;</span><br><span class="line">            throw new BeanInitializationException(msg);</span><br><span class="line">        &#125; else if (!(securityManager instanceof WebSecurityManager)) &#123;</span><br><span class="line">            msg &#x3D; &quot;The security manager does not implement the WebSecurityManager interface.&quot;;</span><br><span class="line">            throw new BeanInitializationException(msg);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            FilterChainManager manager &#x3D; this.createFilterChainManager();</span><br><span class="line">            PathMatchingFilterChainResolver chainResolver &#x3D; new PathMatchingFilterChainResolver();</span><br><span class="line">            chainResolver.setFilterChainManager(manager);</span><br><span class="line">            return new ShiroFilterFactoryBean.SpringShiroFilter((WebSecurityManager)securityManager, chainResolver);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected FilterChainManager createFilterChainManager() &#123;</span><br><span class="line">        DefaultFilterChainManager manager &#x3D; new DefaultFilterChainManager();</span><br><span class="line">        &#x2F;&#x2F; 获取默认的filter</span><br><span class="line">        Map&lt;String, Filter&gt; defaultFilters &#x3D; manager.getFilters();</span><br><span class="line">        Iterator var3 &#x3D; defaultFilters.values().iterator();</span><br><span class="line"></span><br><span class="line">        while(var3.hasNext()) &#123;</span><br><span class="line">            Filter filter &#x3D; (Filter)var3.next();</span><br><span class="line">            this.applyGlobalPropertiesIfNecessary(filter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 获取配置的filter</span><br><span class="line">        Map&lt;String, Filter&gt; filters &#x3D; this.getFilters();</span><br><span class="line">        String name;</span><br><span class="line">        Filter filter;</span><br><span class="line">        if (!CollectionUtils.isEmpty(filters)) &#123;</span><br><span class="line">            for(Iterator var10 &#x3D; filters.entrySet().iterator(); var10.hasNext(); manager.addFilter(name, filter, false)) &#123;</span><br><span class="line">                Entry&lt;String, Filter&gt; entry &#x3D; (Entry)var10.next();</span><br><span class="line">                name &#x3D; (String)entry.getKey();</span><br><span class="line">                filter &#x3D; (Filter)entry.getValue();</span><br><span class="line">                this.applyGlobalPropertiesIfNecessary(filter);</span><br><span class="line">                if (filter instanceof Nameable) &#123;</span><br><span class="line">                    ((Nameable)filter).setName(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 获取配置的FilterChainDefinition</span><br><span class="line">        Map&lt;String, String&gt; chains &#x3D; this.getFilterChainDefinitionMap();</span><br><span class="line">        if (!CollectionUtils.isEmpty(chains)) &#123;</span><br><span class="line">            Iterator var12 &#x3D; chains.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">            while(var12.hasNext()) &#123;</span><br><span class="line">                Entry&lt;String, String&gt; entry &#x3D; (Entry)var12.next();</span><br><span class="line">                String url &#x3D; (String)entry.getKey();</span><br><span class="line">                String chainDefinition &#x3D; (String)entry.getValue();</span><br><span class="line">                manager.createChain(url, chainDefinition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return manager;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>shiro-spring会生成一个filter的bean这个bean就是从ShiroFilterFactoryBean生成，ShiroFilterFactoryBean继承FactoryBean，spring正是从getObject方法来获取filter的bean的，getObject就是调用了createInstance方法<br><code>return new ShiroFilterFactoryBean.SpringShiroFilter((WebSecurityManager)securityManager, chainResolver)</code>createInstance方法返回语句，很明显一个shiroFilter的主要配置类有WebSecurityManager和FilterChainResolver，FilterChainResolver就是关于拦截器的处理器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FilterChainManager manager &#x3D; this.createFilterChainManager();</span><br><span class="line">PathMatchingFilterChainResolver chainResolver &#x3D; new PathMatchingFilterChainResolver();</span><br><span class="line">chainResolver.setFilterChainManager(manager);</span><br></pre></td></tr></table></figure>
<p>createFilterChainManager方法就是根据默认filter以及用户自定义的filter还有definition来生成拦截器管理实例然后注入到FilterChainResolver中，我们可以通过这个manager管理的filter来得知我们的拦截规则以及对应生效的拦截器实例的类，而且这个默认的FilterChainResolver就是PathMatchingFilterChainResolver同样是一个根据路径进行匹配的拦截器处理器，而对应url所需要执行的filter就是FilterChainManager中的filterChians属性配置的，filterChians是一个map，key值就是url匹配规则，value值是一个NamedFilterList，匹配的url按照list的filter顺序执行</p>
<p>因此上面的三个问题中的第二个问题:自定义的filter在filterMap中key命名为默认的filter的名字为什么无法替换,在filterManager中如果和默认的filter重名，是会修改filterMap中对应的key值的.</p>
<p>为了找到答案就需要从拦截器具体生效的逻辑来看</p>
<h4 id="拦截器如何作用"><a href="#拦截器如何作用" class="headerlink" title="拦截器如何作用"></a>拦截器如何作用</h4><p>首先shiro的拦截器是继承了servlet的filter了，因此shiro的拦截机制是基于servlet的拦截机制的，shiro在初始化时注册了shiroFilter这个拦截器注册在servlet的filter中并作为顶级filter.</p>
<p>shiro-spring中这个filter是ShiroFilterFactoryBean中的一个内部类SpringShiroFilter，他继承了AbstractShiroFilter，而AbstractShiroFilter继承了OncePerRequestFilter，简单说明下OncePerRequestFilter，这是一个确保一个拦截器只执行一次的类，它实现了filter的doFilter方法，因此在http进来是shiro的filter机制的入口也就是OncePerRequestFilter的doFilter方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public final void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123;</span><br><span class="line">    String alreadyFilteredAttributeName &#x3D; this.getAlreadyFilteredAttributeName();</span><br><span class="line">    if (request.getAttribute(alreadyFilteredAttributeName) !&#x3D; null) &#123;</span><br><span class="line">        log.trace(&quot;Filter &#39;&#123;&#125;&#39; already executed.  Proceeding without invoking this filter.&quot;, this.getName());</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125; else if (this.isEnabled(request, response) &amp;&amp; !this.shouldNotFilter(request)) &#123;</span><br><span class="line">        log.trace(&quot;Filter &#39;&#123;&#125;&#39; not yet executed.  Executing now.&quot;, this.getName());</span><br><span class="line">        request.setAttribute(alreadyFilteredAttributeName, Boolean.TRUE);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            this.doFilterInternal(request, response, filterChain);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            request.removeAttribute(alreadyFilteredAttributeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        log.debug(&quot;Filter &#39;&#123;&#125;&#39; is not enabled for the current request.  Proceeding without invoking this filter.&quot;, this.getName());</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实所有默认的shiroFilter都实现了OncePerRequestFilter，它主要通过alreadyFilteredAttributeName来控制filter只调用一次，每次使用后对应filter的key都会被记录，而具体filter的实现就是通过doFilterInternal这个方法，到这里其实基本就可以依照我们对应路径得知shiro中它经历的filter逻辑了.</p>
<p>/test/perms对应url访问时对应生效的filter是PermissionsAuthorizationFilter，这个类继承了AdviceFilter，在执行doFilter时调用的就是AdviceFilter的doFilterInternal方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AdviceFilter extends OncePerRequestFilter &#123;</span><br><span class="line">    public void doFilterInternal(ServletRequest request, ServletResponse response, FilterChain chain) throws ServletException, IOException &#123;</span><br><span class="line">        Exception exception &#x3D; null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            boolean continueChain &#x3D; this.preHandle(request, response);</span><br><span class="line">            if (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(&quot;Invoked preHandle method.  Continuing chain?: [&quot; + continueChain + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (continueChain) &#123;</span><br><span class="line">                this.executeChain(request, response, chain);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            this.postHandle(request, response);</span><br><span class="line">            if (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(&quot;Successfully invoked postHandle method&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception var9) &#123;</span><br><span class="line">            exception &#x3D; var9;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            this.cleanup(request, response, exception);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public abstract class PathMatchingFilter extends AdviceFilter implements PathConfigProcessor &#123;</span><br><span class="line"></span><br><span class="line">    protected boolean preHandle(ServletRequest request, ServletResponse response) throws Exception &#123;</span><br><span class="line">        if (this.appliedPaths !&#x3D; null &amp;&amp; !this.appliedPaths.isEmpty()) &#123;</span><br><span class="line">            Iterator var3 &#x3D; this.appliedPaths.keySet().iterator();</span><br><span class="line"></span><br><span class="line">            String path;</span><br><span class="line">            do &#123;</span><br><span class="line">                if (!var3.hasNext()) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                path &#x3D; (String)var3.next();</span><br><span class="line">            &#125; while(!this.pathsMatch(path, request));</span><br><span class="line"></span><br><span class="line">            log.trace(&quot;Current requestURI matches pattern &#39;&#123;&#125;&#39;.  Determining filter chain execution...&quot;, path);</span><br><span class="line">            Object config &#x3D; this.appliedPaths.get(path);</span><br><span class="line">            return this.isFilterChainContinued(request, response, path, config);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(&quot;appliedPaths property is null or empty.  This Filter will passthrough immediately.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean isFilterChainContinued(ServletRequest request, ServletResponse response, String path, Object pathConfig) throws Exception &#123;</span><br><span class="line">        if (this.isEnabled(request, response, path, pathConfig)) &#123;</span><br><span class="line">            if (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(&quot;Filter &#39;&#123;&#125;&#39; is enabled for the current request under path &#39;&#123;&#125;&#39; with config [&#123;&#125;].  Delegating to subclass implementation for &#39;onPreHandle&#39; check.&quot;, new Object[]&#123;this.getName(), path, pathConfig&#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return this.onPreHandle(request, response, pathConfig);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(&quot;Filter &#39;&#123;&#125;&#39; is disabled for the current request under path &#39;&#123;&#125;&#39; with config [&#123;&#125;].  The next element in the FilterChain will be called immediately.&quot;, new Object[]&#123;this.getName(), path, pathConfig&#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public abstract class AccessControlFilter extends PathMatchingFilter &#123;</span><br><span class="line">    public boolean onPreHandle(ServletRequest request, ServletResponse response, Object mappedValue) throws Exception &#123;</span><br><span class="line">        return this.isAccessAllowed(request, response, mappedValue) || this.onAccessDenied(request, response, mappedValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void saveRequestAndRedirectToLogin(ServletRequest request, ServletResponse response) throws IOException &#123;</span><br><span class="line">        this.saveRequest(request);</span><br><span class="line">        this.redirectToLogin(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void redirectToLogin(ServletRequest request, ServletResponse response) throws IOException &#123;</span><br><span class="line">        String loginUrl &#x3D; this.getLoginUrl();</span><br><span class="line">        WebUtils.issueRedirect(request, response, loginUrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">public abstract class AuthorizationFilter extends AccessControlFilter &#123;</span><br><span class="line">    protected boolean onAccessDenied(ServletRequest request, ServletResponse response) throws IOException &#123;</span><br><span class="line">        Subject subject &#x3D; this.getSubject(request, response);</span><br><span class="line">        if (subject.getPrincipal() &#x3D;&#x3D; null) &#123;</span><br><span class="line">            this.saveRequestAndRedirectToLogin(request, response);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String unauthorizedUrl &#x3D; this.getUnauthorizedUrl();</span><br><span class="line">            if (StringUtils.hasText(unauthorizedUrl)) &#123;</span><br><span class="line">                WebUtils.issueRedirect(request, response, unauthorizedUrl);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                WebUtils.toHttp(response).sendError(401);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这方法定义了filter中具体执行逻辑，AdviceFilter.doFilterInternal-&gt;PathMatchingFilter.preHandle-&gt;isFilterChainContinued-&gt;AccessControlFilter.onPreHandle-&gt;AuthorizationFilter.onAccessDenied，<code>this.saveRequestAndRedirectToLogin(request, response)</code>这个就是重定向到登录页面，shiro的默认登录页面就是login.jsp<br>到这里之前三个问题中前面两个问题解决了，http请求并没有进入authc filter但是perm filter同样有重定向到login.jsp的机制，事实上所有继承了AccessControlFilter的filter都有同样的机制，另外同名的filter是可以替换默认的filter的，之所以前面加上自定义filter可以实现需要的功能因为在一个匹配的url中先进入自定义的filter的话，验证的处理在自定义的filter中就会处理不会到后面的filter中.</p>
<h4 id="shiro的session机制"><a href="#shiro的session机制" class="headerlink" title="shiro的session机制"></a>shiro的session机制</h4><p>最后一个问题Insomnia为什么可以通过，最后找到原因因为Insomnia的访问是带cookie的，因此Insomnia登录后的请求并没有走filter验证而是,而是session机制就跳过了验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractShiroFilter extends OncePerRequestFilter &#123;</span><br><span class="line">    protected void doFilterInternal(ServletRequest servletRequest, ServletResponse servletResponse, final FilterChain chain) throws ServletException, IOException &#123;</span><br><span class="line">        Throwable t &#x3D; null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            final ServletRequest request &#x3D; this.prepareServletRequest(servletRequest, servletResponse, chain);</span><br><span class="line">            final ServletResponse response &#x3D; this.prepareServletResponse(request, servletResponse, chain);</span><br><span class="line">            Subject subject &#x3D; this.createSubject(request, response);</span><br><span class="line">            subject.execute(new Callable() &#123;</span><br><span class="line">                public Object call() throws Exception &#123;</span><br><span class="line">                    AbstractShiroFilter.this.updateSessionLastAccessTime(request, response);</span><br><span class="line">                    AbstractShiroFilter.this.executeChain(request, response, chain);</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; catch (ExecutionException var8) &#123;</span><br><span class="line">            t &#x3D; var8.getCause();</span><br><span class="line">        &#125; catch (Throwable var9) &#123;</span><br><span class="line">            t &#x3D; var9;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (t !&#x3D; null) &#123;</span><br><span class="line">            if (t instanceof ServletException) &#123;</span><br><span class="line">                throw (ServletException)t;</span><br><span class="line">            &#125; else if (t instanceof IOException) &#123;</span><br><span class="line">                throw (IOException)t;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                String msg &#x3D; &quot;Filtered request failed.&quot;;</span><br><span class="line">                throw new ServletException(msg, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>doFilterInternal中<code>Subject subject = this.createSubject(request, response)</code>,这会创建Subject，shiro的session也是绑定在Subject中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AdviceFilter extends OncePerRequestFilter &#123;</span><br><span class="line">    public void doFilterInternal(ServletRequest request, ServletResponse response, FilterChain chain) throws ServletException, IOException &#123;</span><br><span class="line">        Exception exception &#x3D; null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            boolean continueChain &#x3D; this.preHandle(request, response);</span><br><span class="line">            if (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(&quot;Invoked preHandle method.  Continuing chain?: [&quot; + continueChain + &quot;]&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (continueChain) &#123;</span><br><span class="line">                this.executeChain(request, response, chain);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            this.postHandle(request, response);</span><br><span class="line">            if (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(&quot;Successfully invoked postHandle method&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception var9) &#123;</span><br><span class="line">            exception &#x3D; var9;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            this.cleanup(request, response, exception);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class PermissionsAuthorizationFilter extends AuthorizationFilter &#123;</span><br><span class="line">    public PermissionsAuthorizationFilter() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) throws IOException &#123;</span><br><span class="line">        Subject subject &#x3D; this.getSubject(request, response);</span><br><span class="line">        String[] perms &#x3D; (String[])((String[])mappedValue);</span><br><span class="line">        boolean isPermitted &#x3D; true;</span><br><span class="line">        if (perms !&#x3D; null &amp;&amp; perms.length &gt; 0) &#123;</span><br><span class="line">            if (perms.length &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                if (!subject.isPermitted(perms[0])) &#123;</span><br><span class="line">                    isPermitted &#x3D; false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (!subject.isPermittedAll(perms)) &#123;</span><br><span class="line">                isPermitted &#x3D; false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return isPermitted;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public abstract class AuthorizationFilter extends AccessControlFilter &#123;</span><br><span class="line">    private String unauthorizedUrl;</span><br><span class="line"></span><br><span class="line">    public AuthorizationFilter() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getUnauthorizedUrl() &#123;</span><br><span class="line">        return this.unauthorizedUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUnauthorizedUrl(String unauthorizedUrl) &#123;</span><br><span class="line">        this.unauthorizedUrl &#x3D; unauthorizedUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected boolean onAccessDenied(ServletRequest request, ServletResponse response) throws IOException &#123;</span><br><span class="line">        Subject subject &#x3D; this.getSubject(request, response);</span><br><span class="line">        if (subject.getPrincipal() &#x3D;&#x3D; null) &#123;</span><br><span class="line">            this.saveRequestAndRedirectToLogin(request, response);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String unauthorizedUrl &#x3D; this.getUnauthorizedUrl();</span><br><span class="line">            if (StringUtils.hasText(unauthorizedUrl)) &#123;</span><br><span class="line">                WebUtils.issueRedirect(request, response, unauthorizedUrl);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                WebUtils.toHttp(response).sendError(401);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>boolean continueChain = this.preHandle(request, response)</code>,preHandler其实就是isAccessAllowed||onAccessDenied的结果，可以看到subject判断permiss通过时isAccessAllowed为true,continueChain自然为true,<code>this.executeChain(request, response, chain)</code>其实就是验证通过继续执行filterChain的doFilter</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">HuangQiang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/09/12/shiro%E5%B1%8F%E8%94%BD%E7%99%BB%E5%BD%95%E6%97%B6%E8%B7%B3%E8%BD%AC%E5%88%B0login/">http://yoursite.com/2020/09/12/shiro%E5%B1%8F%E8%94%BD%E7%99%BB%E5%BD%95%E6%97%B6%E8%B7%B3%E8%BD%AC%E5%88%B0login/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com" target="_blank">HQ BLOG</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/spring/">spring</a><a class="post-meta__tags" href="/tags/security/">security</a><a class="post-meta__tags" href="/tags/shiro/">shiro</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/09/06/1wgrbldpGcPK82A.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/29/mesos%E6%A6%82%E8%BF%B0/"><img class="prev-cover" src="https://i.loli.net/2020/09/06/1wgrbldpGcPK82A.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">mesos概述</div></div></a></div><div class="next-post pull-right"><a href="/2020/09/05/shiro%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F/"><img class="next-cover" src="https://i.loli.net/2020/09/06/1wgrbldpGcPK82A.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">shiro-spring自定义filter</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/09/05/shiro使用注意/" title="shiro-spring自定义filter"><img class="cover" src="https://i.loli.net/2020/09/06/1wgrbldpGcPK82A.jpg"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-09-05</div><div class="title">shiro-spring自定义filter</div></div></a></div><div><a href="/2017/11/17/AutoWired异常/" title="AutoWired异常"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-11-17</div><div class="title">AutoWired异常</div></div></a></div><div><a href="/2018/01/02/Spring-aop/" title="Spring-aop"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-01-02</div><div class="title">Spring-aop</div></div></a></div><div><a href="/2017/10/26/JAVA类加载器/" title="JAVA类加载器"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-10-26</div><div class="title">JAVA类加载器</div></div></a></div><div><a href="/2019/01/24/Java中的Clone/" title="Java中的Clone"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-01-24</div><div class="title">Java中的Clone</div></div></a></div><div><a href="/2018/09/03/Java-NIO/" title="Java NIO"><img class="cover" src="/null"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-09-03</div><div class="title">Java NIO</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2021 By HuangQiang</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, this is hq's blog</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>